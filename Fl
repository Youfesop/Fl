const { Client, GatewayIntentBits, Events, Partials, EmbedBuilder } = require('discord.js');
const express = require('express');

const client = new Client({ 
    intents: [ 
        GatewayIntentBits.Guilds, 
        GatewayIntentBits.GuildMessages, 
        GatewayIntentBits.MessageContent, 
        GatewayIntentBits.GuildMembers 
    ], 
    partials: [Partials.Channel] 
});

// Express server for uptime monitoring
const app = express();

app.get('/', (req, res) => {
  res.send('Bot is alive!');
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, '0.0.0.0', () => {
  console.log('Web server is running on port ' + PORT);
});

// Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ† Ù…Ù† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© (Ø¢Ù…Ù†)
const TOKEN = process.env.BOT_TOKEN;
const CREDIT_CHANNEL_ID = '1370500290788200594';
const RECEIVER_ID = '1122934386615140432';

const rolesData = [
    { name: 'simple person', price: 1000000, roleId: '1375712064311656470' },
    { name: 'donator', price: 5000000, roleId: '1375711474558828594' },
    { name: 'VIP', price: 10000000, roleId: '1371533212374929449' },
    { name: 'super vip', price: 30000000, roleId: '1376586336777146368' }
];

client.on(Events.MessageCreate, async (message) => {
    if (message.channel.id !== CREDIT_CHANNEL_ID || message.author.id !== '282859044593598464') return;

    const probotRegex = /\*\*Ù€ (.*?), Ù‚Ø§Ù… Ø¨ØªØ­ÙˆÙŠÙ„ `\$(\d+)` Ù„Ù€ <@!?1122934386615140432> \*\* \|:moneybag:/;
    const match = message.content.match(probotRegex);
    
    if (!match) return;

    const buyerUsername = match[1];
    const transferAmount = parseInt(match[2]);

    console.log(`ProBot detected transfer: ${buyerUsername} sent $${transferAmount}`);

    const buyerMember = message.guild.members.cache.find(m => 
        m.user.username === buyerUsername || 
        m.displayName === buyerUsername ||
        m.user.globalName === buyerUsername
    );
    
    if (!buyerMember) {
        console.log(`Member not found: ${buyerUsername}`);
        return;
    }

    let selectedRole = null;
    
    for (const role of rolesData) {
        const minAmount = role.price * 0.90;
        const maxAmount = role.price * 1.05;
        
        if (transferAmount >= minAmount && transferAmount <= maxAmount) {
            selectedRole = role;
            break;
        }
    }

    if (!selectedRole) {
        const affordableRoles = rolesData.filter(r => transferAmount >= r.price * 0.85);
        if (affordableRoles.length > 0) {
            selectedRole = affordableRoles.reduce((prev, current) => {
                return (current.price <= transferAmount && current.price > prev.price) ? current : prev;
            });
        }
    }

    if (!selectedRole) {
        console.log(`No suitable role found for amount: $${transferAmount}`);
        return;
    }

    try {
        if (buyerMember.roles.cache.has(selectedRole.roleId)) {
            console.log(`${buyerUsername} already has role ${selectedRole.name}`);
            return;
        }

        await buyerMember.roles.add(selectedRole.roleId);
        console.log(`âœ… Role ${selectedRole.name} given to ${buyerUsername} for $${transferAmount}`);
        
        await message.channel.send(`ØªÙ… Ø´Ø±Ø§Ø¡ Ø§Ù„Ø±ØªØ¨Ø© Ø¨Ù†Ø¬Ø§Ø­ Ø§Ø³ØªÙ…ØªØ¹ ðŸ—¿ðŸ‘Œ\n**${buyerUsername}** Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø±ØªØ¨Ø© **${selectedRole.name}**!`);
        
    } catch (err) {
        console.error('Error giving role:', err);
    }
});

client.once(Events.ClientReady, () => {
    console.log(`âœ… Logged in as ${client.user.tag}`);
});

client.on(Events.InteractionCreate, async (interaction) => {
  if (interaction.isChatInputCommand()) {
    if (interaction.commandName === "buy_role") {
      const roleKey = interaction.options.getString("role");
      const role = rolesData.find(r => r.name.toLowerCase() === roleKey?.toLowerCase());
      if (!role) {
        return interaction.reply({ content: `âŒ Ø§Ù„Ø±ØªØ¨Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.`, ephemeral: true });
      }

      const commandText = `c ${RECEIVER_ID} ${role.price}`;
      
      const embed = new EmbedBuilder()
        .setTitle(`ðŸ›’ Ø´Ø±Ø§Ø¡ Ø±ØªØ¨Ø© ${role.name}`)
        .setDescription(`ðŸ’° Ø§Ù„Ø³Ø¹Ø±: $${role.price.toLocaleString()}\n\nðŸ”¥ **Ù„Ø´Ø±Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø±ØªØ¨Ø©ØŒ Ø§Ù†Ø³Ø® Ø§Ù„Ø£Ù…Ø± Ø§Ù„ØªØ§Ù„ÙŠ:**`)
        .addFields({ 
          name: 'ðŸ“ Ø§ÙƒØªØ¨ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø±:', 
          value: `\`${commandText}\``, 
          inline: false 
        })
        .setColor('#00ff00')
        .setFooter({ text: 'Ø§Ù†Ø³Ø® Ø§Ù„Ø£Ù…Ø±!' });

      await interaction.reply({
        embeds: [embed],
        ephemeral: true
      });
    }
  }
});

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ù…Ø±
client.on(Events.ClientReady, async () => {
  const data = [
    {
      name: "buy_role",
      description: "Ø´Ø±Ø§Ø¡ Ø±ØªØ¨Ø©",
      options: [
        {
          name: "role",
          type: 3,
          description: "Ø§Ø®ØªØ± Ø§Ù„Ø±ØªØ¨Ø©",
          required: true,
          choices: rolesData.map((role) => ({
            name: role.name,
            value: role.name
          }))
        }
      ]
    }
  ];
  
  const guilds = client.guilds.cache;
  for (const guild of guilds.values()) {
    await guild.commands.set(data);
  }
  console.log("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£ÙˆØ§Ù…Ø±.");
});

client.login(TOKEN);{
  "name": "discord-role-bot",
  "version": "1.0.0",
  "main": "index.js",
  "description": "Discord role shop bot",
  "scripts": {
    "start": "node index.js"
  },
  "dependencies": {
    "discord.js": "^14.0.0",
    "express": "^4.18.2"
  }
}start: node index.jsnode_modules
.env
